<!DOCTYPE html>
<html>

<head>
    <title>ä½“é‡çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .panel-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .user-filter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #edf2f7;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-filter:hover {
            background: #e2e8f0;
        }

        .user-filter input {
            margin: 0;
            cursor: pointer;
        }

        .user-filter span {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: #2980b9;
        }

        canvas {
            width: 100% !important;
            height: 400px !important;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        th {
            background-color: #f1f5f9;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .date-cell {
            font-weight: 600;
            background: #f0f7ff;
        }

        .weight-cell {
            font-weight: 600;
            position: relative;
        }

        .delta {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.7em;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .positive {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .negative {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .highlight {
            background-color: #fff9db !important;
        }

        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 25px;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-detail {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .trend-up {
            color: #27ae60;
        }

        .trend-down {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .controls {
                flex-direction: column;
            }

            .panel {
                padding: 20px 15px;
            }

            th,
            td {
                padding: 8px 10px;
            }

            .stat-card {
                min-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ“Š å›¢é˜Ÿä½“é‡è¿½è¸ªçœ‹æ¿</h1>
        <p>æ•°æ®æ›´æ–°æ—¶é—´: <span id="updateTime">--</span></p>
    </div>

    <div class="dashboard">
        <div class="panel">
            <div class="panel-title">
                <span>ä½“é‡å˜åŒ–è¶‹åŠ¿å›¾</span>
            </div>

            <div class="controls">
                <div class="filter-group">
                    <strong>ç­›é€‰æˆå‘˜ï¼š</strong>
                    <div id="filterContainer"></div>
                </div>
                <button onclick="refreshData()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                        <path
                            d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                    </svg>
                    åˆ·æ–°æ•°æ®
                </button>
            </div>

            <canvas id="weightChart"></canvas>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span>è¯¦ç»†æ•°æ®è¡¨</span>
                <div>
                    <label><input type="checkbox" id="showDelta" onchange="renderTable()"> æ˜¾ç¤ºå˜åŒ–é‡</label>
                </div>
            </div>

            <table id="weightTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>æœ€è½»ä½“é‡</h3>
                <div class="stat-value" id="minWeight">--</div>
                <div class="stat-detail" id="minWeightDetail">--</div>
            </div>
            <div class="stat-card">
                <h3>æœ€é‡ä½“é‡</h3>
                <div class="stat-value" id="maxWeight">--</div>
                <div class="stat-detail" id="maxWeightDetail">--</div>
            </div>
            <div class="stat-card">
                <h3>å¹³å‡ä½“é‡</h3>
                <div class="stat-value" id="avgWeight">--</div>
                <div class="stat-detail" id="avgTrend">--</div>
            </div>
        </div>
    </div>

    <script>
        // ===== é…ç½®åŒºåŸŸ =====
        const CONFIG = {
            SHEET_ID: "1MOELPmNQ0M9cFupYic6MTSKrBq8aehRdJ-sILfPoTOw", // æ›¿æ¢ä¸ºä½ çš„è¡¨æ ¼ID
            MEMBER_COLORS: {
                'PD': '#FF6384',
                'AX': '#36A2EB',
                'YC': '#FFCE56',
                'GL': '#4BC0C0',
            },
            REFRESH_INTERVAL: 300000 // 5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯«ç§’ï¼‰
        };
        // ===================

        // å…¨å±€å˜é‡
        let chart = null;
        let rawData = {};
        let prevData = null;

        // å·¥å…·å‡½æ•°ï¼šè·å–æ ¼å¼åŒ–æ—¶é—´
        function getFormattedTime() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆéšæœºé¢œè‰²
        function getRandomColor() {
            return `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}`;
        }

        // ä»Googleè¡¨æ ¼è·å–æ•°æ®
        async function fetchData() {
            const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&t=${Date.now()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const text = await response.text();
                const jsonText = text.match(/\{.*\}/s);
                if (!jsonText) throw new Error('Invalid response format');

                return JSON.parse(jsonText[0]);
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                alert(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
                return null;
            }
        }

        // å¤„ç†è¡¨æ ¼æ•°æ®ï¼ˆæ–°æ ¼å¼ï¼‰
        function processData(jsonData) {
            const table = jsonData.table;
            const rows = table.rows;

            // è·å–æˆå‘˜åˆ—è¡¨ï¼ˆç¬¬ä¸€è¡Œï¼Œä»ç¬¬äºŒåˆ—å¼€å§‹ï¼‰
            const members = [];
            const headerCells = rows[0].c;
            for (let i = 1; i < headerCells.length; i++) {
                if (headerCells[i] && headerCells[i].v) {
                    members.push(headerCells[i].v);
                }
            }

            // å¤„ç†æ•°æ®è¡Œ
            const dataByDate = {};
            const allWeights = [];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].c;
                if (!row[0] || !row[0].v) continue;

                const date = new Date(row[0].v);
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼

                const dateData = { date: dateStr, rawDate: date };

                for (let j = 0; j < members.length; j++) {
                    const colIndex = j + 1;
                    if (row[colIndex] && row[colIndex].v !== null) {
                        const weight = parseFloat(row[colIndex].v);
                        if (!isNaN(weight)) {
                            dateData[members[j]] = weight;
                            allWeights.push({
                                member: members[j],
                                date: dateStr,
                                weight: weight
                            });
                        }
                    }
                }

                dataByDate[dateStr] = dateData;
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedDates = Object.keys(dataByDate).sort((a, b) =>
                new Date(a) - new Date(b)
            );

            return {
                members,
                dates: sortedDates,
                dataByDate,
                allWeights
            };
        }

        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        function calculateStats() {
            if (!rawData.allWeights || rawData.allWeights.length === 0) return;

            // è®¡ç®—æœ€è½»ä½“é‡
            const minEntry = rawData.allWeights.reduce((min, curr) =>
                curr.weight < min.weight ? curr : min
            );
            document.getElementById('minWeight').textContent = minEntry.weight.toFixed(1);
            document.getElementById('minWeightDetail').innerHTML =
                `${minEntry.member} Â· ${minEntry.date}`;

            // è®¡ç®—æœ€é‡ä½“é‡
            const maxEntry = rawData.allWeights.reduce((max, curr) =>
                curr.weight > max.weight ? curr : max
            );
            document.getElementById('maxWeight').textContent = maxEntry.weight.toFixed(1);
            document.getElementById('maxWeightDetail').innerHTML =
                `${maxEntry.member} Â· ${maxEntry.date}`;

            // è®¡ç®—å¹³å‡ä½“é‡
            const totalWeight = rawData.allWeights.reduce((sum, curr) => sum + curr.weight, 0);
            const avgWeight = totalWeight / rawData.allWeights.length;
            document.getElementById('avgWeight').textContent = avgWeight.toFixed(1);

            // è®¡ç®—å¹³å‡ä½“é‡è¶‹åŠ¿
            if (prevData && prevData.allWeights.length > 0) {
                const prevTotal = prevData.allWeights.reduce((sum, curr) => sum + curr.weight, 0);
                const prevAvg = prevTotal / prevData.allWeights.length;
                const trend = avgWeight - prevAvg;
                const trendClass = trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : '';
                const trendIcon = trend > 0 ? 'â†‘' : trend < 0 ? 'â†“' : 'â†’';

                document.getElementById('avgTrend').innerHTML =
                    `è¾ƒä¸Šæ¬¡ <span class="${trendClass}">${trendIcon} ${Math.abs(trend).toFixed(1)}kg</span>`;
            } else {
                document.getElementById('avgTrend').textContent = 'æš‚æ— è¶‹åŠ¿æ•°æ®';
            }
        }

        // æ¸²æŸ“æˆå‘˜ç­›é€‰å™¨
        function renderFilters() {
            const container = document.getElementById('filterContainer');
            container.innerHTML = '';

            rawData.members.forEach(member => {
                const color = CONFIG.MEMBER_COLORS[member] || getRandomColor();

                const filter = document.createElement('div');
                filter.className = 'user-filter';
                filter.innerHTML = `
          <input 
            type="checkbox" 
            name="user" 
            value="${member}" 
            checked
            onchange="renderChart()"
          >
          <span style="background:${color}"></span>
          ${member}
        `;
                container.appendChild(filter);
            });
        }

        // ç»˜åˆ¶å›¾è¡¨
        function renderChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const selectedMembers = Array.from(
                document.querySelectorAll('input[name="user"]:checked')
            ).map(el => el.value);

            // å‡†å¤‡å›¾è¡¨æ•°æ®é›†
            const datasets = selectedMembers.map(member => {
                const color = CONFIG.MEMBER_COLORS[member] || getRandomColor();
                const dataPoints = [];

                rawData.dates.forEach(date => {
                    if (rawData.dataByDate[date][member] !== undefined) {
                        dataPoints.push({
                            x: rawData.dataByDate[date].rawDate,
                            y: rawData.dataByDate[date][member]
                        });
                    }
                });

                return {
                    label: member,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '20', // æ·»åŠ é€æ˜åº¦
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: color,
                    tension: 0.2,
                    fill: false
                };
            });

            // é”€æ¯æ—§å›¾è¡¨
            if (chart) chart.destroy();

            // åˆ›å»ºæ–°å›¾è¡¨
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)',
                                font: { size: 14 }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: { day: 'MMM d' }
                            },
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ',
                                font: { size: 14 }
                            },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#2d3748',
                            bodyColor: '#4a5568',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            boxPadding: 4,
                            usePointStyle: true,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}kg`
                            }
                        }
                    }
                }
            });
        }

        // æ¸²æŸ“æ•°æ®è¡¨æ ¼
        function renderTable() {
            const showDelta = document.getElementById('showDelta').checked;
            const headerRow = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');

            // æ¸…ç©ºè¡¨æ ¼
            headerRow.innerHTML = '';
            tableBody.innerHTML = '';

            // åˆ›å»ºè¡¨å¤´
            const dateHeader = document.createElement('th');
            dateHeader.textContent = 'æ—¥æœŸ';
            dateHeader.className = 'date-cell';
            headerRow.appendChild(dateHeader);

            rawData.members.forEach(member => {
                const memberHeader = document.createElement('th');
                memberHeader.textContent = member;
                memberHeader.style.color = CONFIG.MEMBER_COLORS[member] || '#2d3748';
                headerRow.appendChild(memberHeader);
            });

            // æ·»åŠ æ•°æ®è¡Œ
            let prevDateData = null;
            rawData.dates.forEach(date => {
                const row = document.createElement('tr');
                const dateData = rawData.dataByDate[date];

                // æ—¥æœŸå•å…ƒæ ¼
                const dateCell = document.createElement('td');
                dateCell.textContent = date;
                dateCell.className = 'date-cell';
                row.appendChild(dateCell);

                // æˆå‘˜ä½“é‡å•å…ƒæ ¼
                rawData.members.forEach(member => {
                    const weightCell = document.createElement('td');
                    weightCell.className = 'weight-cell';

                    if (dateData[member] !== undefined) {
                        weightCell.textContent = dateData[member].toFixed(1);

                        // æ˜¾ç¤ºå˜åŒ–é‡
                        if (showDelta && prevDateData && prevDateData[member] !== undefined) {
                            const delta = dateData[member] - prevDateData[member];
                            const deltaSpan = document.createElement('span');
                            deltaSpan.className = `delta ${delta > 0 ? 'positive' : 'negative'}`;
                            deltaSpan.textContent = delta > 0 ? `+${delta.toFixed(1)}` : delta.toFixed(1);
                            weightCell.appendChild(deltaSpan);
                        }
                    } else {
                        weightCell.textContent = '-';
                    }

                    row.appendChild(weightCell);
                });

                tableBody.appendChild(row);
                prevDateData = dateData;
            });
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                document.getElementById('updateTime').textContent = getFormattedTime();

                // ä¿å­˜å½“å‰æ•°æ®ä½œä¸ºå†å²å‚è€ƒ
                prevData = rawData;

                // è·å–æ–°æ•°æ®
                const jsonData = await fetchData();
                if (!jsonData) return;

                // å¤„ç†æ•°æ®
                rawData = processData(jsonData);

                // é¦–æ¬¡åŠ è½½æ—¶æ¸²æŸ“ç­›é€‰å™¨
                if (!document.getElementById('filterContainer').innerHTML) {
                    renderFilters();
                }

                // æ¸²æŸ“å›¾è¡¨å’Œè¡¨æ ¼
                renderChart();
                renderTable();

                // è®¡ç®—å¹¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                calculateStats();

                console.log('æ•°æ®åˆ·æ–°æˆåŠŸ');
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®æ—¶å‡ºé”™:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œ
        window.onload = () => {
            refreshData();
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
        };
    </script>
</body>

</html>