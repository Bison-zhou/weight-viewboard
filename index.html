<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“é‡è¿½è¸ªçœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <style>
        /* CSS æ ·å¼è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–å’Œç¾åŒ– */
        :root {
            --primary-color: #3498db;
            --primary-color-dark: #2980b9;
            --text-color: #2c3e50;
            --background-color: #f4f7f9;
            --panel-background: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --font-family: 'Segoe UI', 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--panel-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .header h1 {
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .panel {
            background: var(--panel-background);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.07);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .panel-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .user-filter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #edf2f7;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-filter:hover {
            background: #e2e8f0;
        }

        .user-filter input {
            margin: 0;
            cursor: pointer;
        }

        .user-filter span {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: var(--primary-color-dark);
        }

        button:active {
            transform: scale(0.98);
        }

        #chartContainer {
            position: relative;
            min-height: 400px;
        }

        canvas {
            width: 100% !important;
            height: 400px !important;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        th {
            background-color: #f1f5f9;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .date-cell {
            font-weight: 600;
            background: #f0f7ff;
        }

        .weekend-highlight {
            background-color: #fff9db !important;
        }

        .weight-cell {
            font-weight: 600;
            position: relative;
        }

        .delta {
            font-size: 0.75em;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .positive {
            color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
        }

        .negative {
            color: var(--danger-color);
            background: rgba(231, 76, 60, 0.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background: var(--panel-background);
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .stat-detail {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .status-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -25px;
            margin-left: -25px;
            z-index: 10;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .panel {
                padding: 20px 15px;
            }

            th,
            td {
                padding: 8px 10px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ“‰ Body Weight</h1>
        <p>æ•°æ®æ›´æ–°æ—¶é—´: <span id="updateTime">--</span></p>
        <div id="statusMessage" class="status-message" style="display:none;"></div>
    </div>

    <div class="dashboard">
        <div class="panel">
            <div class="panel-title">
                <span>ä½“é‡å˜åŒ–è¶‹åŠ¿å›¾</span>
            </div>
            <div class="controls">
                <div class="filter-group">
                    <strong>ç­›é€‰æˆå‘˜ï¼š</strong>
                    <div id="filterContainer"></div>
                </div>
                <button onclick="refreshData()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                        <path
                            d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                    </svg>
                    åˆ·æ–°æ•°æ®
                </button>
            </div>
            <div id="chartContainer">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span><i class="fas fa-candle-holder"></i> æˆå‘˜ä½“é‡å‘¨Kçº¿å›¾</span>
            </div>

            <div class="candle-charts" id="candleChartsContainer">
                <!-- å‘¨Kçº¿å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span>è¯¦ç»†æ•°æ®è¡¨</span>
                <div>
                    <label style="cursor:pointer; font-size: 0.9em;"><input type="checkbox" id="showDelta"
                            onchange="renderTable()"> æ˜¾ç¤ºä¸ä¸Šæ¬¡æ•°æ®çš„å˜åŒ–é‡</label>
                </div>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="weightTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ===== é…ç½®åŒºåŸŸ =====
        const CONFIG = {
            SHEET_ID: "1MOELPmNQ0M9cFupYic6MTSKrBq8aehRdJ-sILfPoTOw", // è¿™æ˜¯ä½ çš„è¡¨æ ¼ID
            MEMBER_COLORS: {
                'PD': '#7093DB', 'AX': '#BC1717', 'YC': '#000000', 'GL': '#FFCE56',
            },
            REFRESH_INTERVAL: 300000, // 5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯«ç§’ï¼‰
            DEBUG_MODE: true
        };
        // ===================

        // å…¨å±€å˜é‡
        // let chart = null; // ã€ä¿®æ­£ã€‘ä¸å†éœ€è¦å…¨å±€å˜é‡æ¥è·Ÿè¸ªå›¾è¡¨å®ä¾‹
        let rawData = {};

        // å·¥å…·å‡½æ•°ï¼šè·å–æ ¼å¼åŒ–æ—¶é—´
        const getFormattedTime = () => new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

        // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆéšæœºé¢œè‰²
        const getRandomColor = () => `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}`;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function toggleLoader(show) {
            let loader = document.getElementById('loader');
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'loader';
                    loader.className = 'loader';
                    document.getElementById('chartContainer').appendChild(loader);
                }
            } else {
                if (loader) {
                    loader.remove();
                }
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.className = `status-message ${isError ? 'status-error' : 'status-info'}`;
            if (!isError) {
                setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
            }
        }

        // ä»Googleè¡¨æ ¼è·å–æ•°æ®
        async function fetchData() {
            const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&t=${Date.now()}`;
            if (CONFIG.DEBUG_MODE) console.log(`[INFO] è¯·æ±‚æ•°æ®: ${url}`);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);

                const text = await response.text();
                const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);

                if (!jsonMatch || !jsonMatch[1]) {
                    throw new Error('æ— æ³•ä»å“åº”ä¸­è§£æJSONPæ•°æ®ã€‚');
                }

                const jsonData = JSON.parse(jsonMatch[1]);
                if (jsonData.status === 'error') {
                    const errorDetails = jsonData.errors.map(e => e.detailed_message).join('\n');
                    throw new Error(`Google Sheet API é”™è¯¯: ${errorDetails}`);
                }

                return jsonData;
            } catch (error) {
                console.error('[ERROR] è·å–æ•°æ®å¤±è´¥:', error);
                showStatus(`è·å–æ•°æ®å¤±è´¥: ${error.message}`, true);
                return null;
            }
        }

        // å¤„ç†è¡¨æ ¼æ•°æ®
        function processData(jsonData) {
            if (!jsonData || !jsonData.table) {
                throw new Error('æ— æ•ˆçš„JSONæ•°æ®');
            }

            const table = jsonData.table;
            const rows = table.rows;

            if (!rows || rows.length < 1) {
                throw new Error('è¡¨æ ¼ä¸­æ²¡æœ‰æ•°æ®');
            }

            // è·å–æˆå‘˜åˆ—è¡¨ï¼ˆç¬¬ä¸€è¡Œï¼Œä»ç¬¬äºŒåˆ—å¼€å§‹ï¼‰
            const members = [];
            const headerCells = rows[0].c;

            for (let i = 1; i < headerCells.length; i++) {
                if (headerCells[i] && headerCells[i].v) {
                    members.push(headerCells[i].v);
                } else if (headerCells[i] === null) {
                    continue;
                } else {
                    break;
                }
            }

            if (members.length === 0) {
                throw new Error('æœªæ‰¾åˆ°æˆå‘˜åç§°');
            }

            // å¤„ç†æ•°æ®è¡Œ
            const dataByDate = {};
            const allWeights = [];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].c;
                if (!row || row.length === 0 || !row[0] || !row[0].v) continue;

                const dateValue = row[0].v;
                const date = new Date(dateValue);

                if (isNaN(date.getTime())) {
                    console.warn(`æ— æ•ˆæ—¥æœŸ: ${dateValue} - è·³è¿‡æ­¤è¡Œ`);
                    continue;
                }

                const dateStr = date.toISOString().split('T')[0];
                const dateData = { date: dateStr, rawDate: date };

                for (let j = 0; j < members.length; j++) {
                    const colIndex = j + 1;
                    if (row[colIndex] && row[colIndex].v !== null) {
                        const weightValue = row[colIndex].v;
                        const weight = parseFloat(weightValue);

                        if (!isNaN(weight)) {
                            dateData[members[j]] = weight;
                            allWeights.push({
                                member: members[j],
                                date: dateStr,
                                weight: weight
                            });
                        } else {
                            console.warn(`æ— æ•ˆä½“é‡å€¼: ${weightValue} - ${members[j]} - ${dateStr}`);
                        }
                    }
                }

                dataByDate[dateStr] = dateData;
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedDates = Object.keys(dataByDate).sort((a, b) =>
                new Date(a) - new Date(b)
            );

            return {
                members,
                dates: sortedDates,
                dataByDate,
                allWeights
            };
        }

        // è®¡ç®—æ¯å‘¨Kçº¿æ•°æ®
        function calculateWeeklyCandleData() {
            if (!rawData.dates || rawData.dates.length === 0) return {};

            const weeklyData = {};

            // åˆå§‹åŒ–æ¯ä¸ªæˆå‘˜çš„æ•°æ®ç»“æ„
            rawData.members.forEach(member => {
                weeklyData[member] = [];
            });

            // æŒ‰å‘¨åˆ†ç»„æ•°æ®
            const weeks = {};
            rawData.dates.forEach(dateStr => {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const weekNum = getWeekNumber(date);
                const weekKey = `${year}-W${weekNum.toString().padStart(2, '0')}`;

                if (!weeks[weekKey]) {
                    weeks[weekKey] = {
                        startDate: null,
                        endDate: null,
                        data: {}
                    };
                }

                // è®¾ç½®å‘¨çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
                if (!weeks[weekKey].startDate || new Date(dateStr) < new Date(weeks[weekKey].startDate)) {
                    weeks[weekKey].startDate = dateStr;
                }
                if (!weeks[weekKey].endDate || new Date(dateStr) > new Date(weeks[weekKey].endDate)) {
                    weeks[weekKey].endDate = dateStr;
                }

                // æ”¶é›†æ¯å‘¨æ•°æ®
                rawData.members.forEach(member => {
                    if (!weeks[weekKey].data[member]) {
                        weeks[weekKey].data[member] = [];
                    }

                    const weight = rawData.dataByDate[dateStr][member];
                    if (weight !== undefined) {
                        weeks[weekKey].data[member].push({
                            date: dateStr,
                            weight: weight
                        });
                    }
                });
            });

            // è®¡ç®—æ¯ä¸ªæˆå‘˜çš„æ¯å‘¨Kçº¿æ•°æ®
            Object.keys(weeks).forEach(weekKey => {
                const week = weeks[weekKey];

                rawData.members.forEach(member => {
                    if (!week.data[member] || week.data[member].length === 0) return;

                    // æŒ‰æ—¥æœŸæ’åºå‘¨å†…æ•°æ®
                    week.data[member].sort((a, b) => new Date(a.date) - new Date(b.date));

                    // å¼€ç›˜ä»·ï¼ˆå‘¨ä¸€ï¼‰
                    const open = week.data[member][0].weight;

                    // æ”¶ç›˜ä»·ï¼ˆå‘¨æ—¥ï¼‰
                    const close = week.data[member][week.data[member].length - 1].weight;

                    // æœ€é«˜ä»·å’Œæœ€ä½ä»·
                    const weights = week.data[member].map(d => d.weight);
                    const high = Math.max(...weights);
                    const low = Math.min(...weights);

                    weeklyData[member].push({
                        week: weekKey,
                        startDate: week.startDate,
                        endDate: week.endDate,
                        open: open,
                        high: high,
                        low: low,
                        close: close,
                        change: close - open,
                        changePercent: ((close - open) / open * 100).toFixed(2)
                    });
                });
            });

            return weeklyData;
        }

        // è·å–ISOå‘¨æ•°
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        }

        // æ¸²æŸ“æˆå‘˜ç­›é€‰å™¨
        function renderFilters() {
            const container = document.getElementById('filterContainer');
            container.innerHTML = '';
            rawData.members.forEach(member => {
                const color = CONFIG.MEMBER_COLORS[member] || getRandomColor();
                const filter = document.createElement('label');
                filter.className = 'user-filter';
                filter.innerHTML = `
                    <input type="checkbox" name="user" value="${member}" checked onchange="renderChart()">
                    <span style="background:${color}"></span>
                    ${member}
                `;
                container.appendChild(filter);
            });
        }

        // ç»˜åˆ¶å‘¨Kçº¿å›¾
        function renderCandleCharts() {
            const container = document.getElementById('candleChartsContainer');
            container.innerHTML = '';

            const weeklyData = calculateWeeklyCandleData();

            rawData.members.forEach((member, index) => {
                if (!weeklyData[member] || weeklyData[member].length === 0) return;

                const chartId = `candleChart${index}`;
                const color = CONFIG.MEMBER_COLORS[member] || getRandomColor();

                // åˆ›å»ºå›¾è¡¨å®¹å™¨
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `
                    <div class="chart-title">${member} ä½“é‡å‘¨Kçº¿å›¾</div>
                    <canvas id="${chartId}"></canvas>
                `;
                container.appendChild(chartContainer);

                // å‡†å¤‡æ•°æ®
                const data = weeklyData[member].map(week => ({
                    x: new Date(week.endDate),
                    o: week.open,
                    h: week.high,
                    l: week.low,
                    c: week.close,
                    change: week.change,
                    changePercent: week.changePercent
                }));

                // åˆ›å»ºå›¾è¡¨
                const ctx = document.getElementById(chartId).getContext('2d');

                if (candleCharts[member]) {
                    candleCharts[member].destroy();
                }

                candleCharts[member] = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: `${member} ä½“é‡`,
                            data: data,
                            color: {
                                up: '#00d2b4',
                                down: '#ff6b6b',
                                unchanged: '#aaaaaa',
                            },
                            borderColor: {
                                up: '#00d2b4',
                                down: '#ff6b6b',
                                unchanged: '#aaaaaa',
                            },
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'week',
                                    displayFormats: {
                                        week: 'MMM d'
                                    },
                                    tooltipFormat: 'MMM d, yyyy'
                                },
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: 'bold'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: 'bold'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'ä½“é‡ (kg)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const point = context.raw;
                                        return [
                                            `å¼€ç›˜: ${point.o.toFixed(2)}kg`,
                                            `æ”¶ç›˜: ${point.c.toFixed(2)}kg`,
                                            `æœ€é«˜: ${point.h.toFixed(2)}kg`,
                                            `æœ€ä½: ${point.l.toFixed(2)}kg`,
                                            `å˜åŒ–: ${point.change.toFixed(2)}kg (${point.changePercent}%)`
                                        ];
                                    }
                                }
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            });
        }

        // ç»˜åˆ¶å›¾è¡¨
        function renderChart() {
            // ã€ä¿®æ­£ã€‘ä½¿ç”¨ Chart.js çš„å®˜æ–¹APIæ¥è·å–å¹¶é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹ï¼Œè¿™æ˜¯æœ€ç¨³å¦¥çš„æ–¹æ³•
            const canvasId = 'weightChart';
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) {
                existingChart.destroy();
            }

            const ctx = document.getElementById(canvasId);
            if (!ctx || !rawData.dates) return;

            const selectedMembers = Array.from(document.querySelectorAll('input[name="user"]:checked')).map(el => el.value);
            if (selectedMembers.length === 0) {
                showStatus("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæˆå‘˜æ¥æ˜¾ç¤ºå›¾è¡¨", true);
                // æ¸…ç©ºç”»å¸ƒ
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            const datasets = selectedMembers.map(member => ({
                label: member,
                data: rawData.dates.map(date => ({
                    x: rawData.dataByDate[date].rawDate,
                    y: rawData.dataByDate[date][member]
                })).filter(p => p.y !== undefined),
                borderColor: CONFIG.MEMBER_COLORS[member] || getRandomColor(),
                backgroundColor: (CONFIG.MEMBER_COLORS[member] || getRandomColor()) + '30',
                borderWidth: 2.5,
                pointRadius: 1.5,
                pointHoverRadius: 2.5,
                pointBackgroundColor: CONFIG.MEMBER_COLORS[member] || getRandomColor(),
                tension: 0.3,
                fill: false
            }));

            // ã€ä¿®æ­£ã€‘ç›´æ¥åˆ›å»ºæ–°å›¾è¡¨ï¼Œä¸å†å°†å…¶èµ‹å€¼ç»™å…¨å±€å˜é‡
            new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { title: { display: true, text: 'ä½“é‡ (kg)', font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { type: 'time', time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd', displayFormats: { day: 'MMM d' } }, title: { display: true, text: 'æ—¥æœŸ', font: { size: 14, weight: 'bold' } }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 4, padding: 40, font: { size: 15, weight: 'bold' } } },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#333', bodyColor: '#555',
                            borderColor: '#ddd', borderWidth: 1, padding: 12, usePointStyle: true,
                            callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} kg` }
                        }
                    }
                }
            });
        }

        // æ¸²æŸ“æ•°æ®è¡¨æ ¼
        function renderTable() {
            const showDelta = document.getElementById('showDelta').checked;
            const headerRow = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            headerRow.innerHTML = ''; tableBody.innerHTML = '';

            const dateHeader = document.createElement('th');
            dateHeader.textContent = 'æ—¥æœŸ';
            headerRow.appendChild(dateHeader);
            rawData.members.forEach(member => {
                const memberHeader = document.createElement('th');
                memberHeader.textContent = member;
                memberHeader.style.color = CONFIG.MEMBER_COLORS[member] || '#333';
                headerRow.appendChild(memberHeader);
            });

            [...rawData.dates].reverse().forEach(date => {
                const row = document.createElement('tr');
                const dateData = rawData.dataByDate[date];
                const dayOfWeek = dateData.rawDate.getDay();

                const dateCell = document.createElement('td');
                dateCell.textContent = date;
                dateCell.className = 'date-cell';
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    row.classList.add('weekend-highlight');
                }
                row.appendChild(dateCell);

                rawData.members.forEach(member => {
                    const weightCell = document.createElement('td');
                    weightCell.className = 'weight-cell';
                    if (dateData[member] !== undefined) {
                        weightCell.innerHTML = `<span>${dateData[member].toFixed(1)}</span>`;
                        if (showDelta) {
                            let prevWeight = null;
                            for (let i = rawData.dates.indexOf(date) - 1; i >= 0; i--) {
                                const prevDate = rawData.dates[i];
                                if (rawData.dataByDate[prevDate][member] !== undefined) {
                                    prevWeight = rawData.dataByDate[prevDate][member];
                                    break;
                                }
                            }
                            if (prevWeight !== null) {
                                const delta = dateData[member] - prevWeight;
                                if (Math.abs(delta) > 0.01) {
                                    const deltaSpan = document.createElement('span');
                                    deltaSpan.className = `delta ${delta > 0 ? 'negative' : 'positive'}`;
                                    deltaSpan.textContent = delta > 0 ? `+${delta.toFixed(1)}` : delta.toFixed(1);
                                    weightCell.appendChild(deltaSpan);
                                }
                            }
                        }
                    } else {
                        weightCell.textContent = '-';
                    }
                    row.appendChild(weightCell);
                });
                tableBody.appendChild(row);
            });
        }

        // ä¸»åˆ·æ–°å‡½æ•°
        async function refreshData() {
            toggleLoader(true);
            document.getElementById('chartContainer').style.opacity = '0.5';
            showStatus("æ­£åœ¨åŠ è½½æœ€æ–°æ•°æ®...", false);

            try {
                const jsonData = await fetchData();
                if (!jsonData) {
                    toggleLoader(false);
                    document.getElementById('chartContainer').style.opacity = '1';
                    return;
                }

                const isFirstLoad = !rawData.members;
                rawData = processData(jsonData);

                if (isFirstLoad) {
                    renderFilters();
                }

                renderChart();
                renderTable();
                calculateStats();

                document.getElementById('updateTime').textContent = getFormattedTime();
                showStatus("æ•°æ®åŠ è½½æˆåŠŸ!", false);

            } catch (error) {
                console.error('[ERROR] å¤„ç†æ•°æ®æ—¶å‡ºé”™:', error);
                showStatus(`å¤„ç†æ•°æ®å‡ºé”™: ${error.message}`, true);
                // å³ä½¿å‡ºé”™ï¼Œä¹Ÿè¦ç¡®ä¿å›¾è¡¨è¢«æ­£ç¡®é”€æ¯ï¼Œä»¥é˜²ä¸‹æ¬¡åˆ·æ–°å¤±è´¥
                renderChart();
            } finally {
                toggleLoader(false);
                document.getElementById('chartContainer').style.opacity = '1';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œ
        window.onload = () => {
            refreshData();
            if (CONFIG.REFRESH_INTERVAL > 0) {
                setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
            }
        };
    </script>
</body>

</html>